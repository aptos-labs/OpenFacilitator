---
phase: 16-investigate-whitelabel-volume-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/db/reward-addresses.ts
  - packages/server/src/db/facilitators.ts
  - packages/server/src/routes/admin.ts
  - packages/server/src/routes/internal-webhooks.ts
autonomous: true

must_haves:
  truths:
    - "Facilitator owners with white-labeled facilitators see their volume on rewards page"
    - "Volume aggregation includes transactions processed by owned facilitators"
    - "New facilitator owners automatically get enrollment markers"
    - "Existing facilitator owners get markers via backfill"
  artifacts:
    - path: "packages/server/src/db/reward-addresses.ts"
      provides: "createFacilitatorMarker function for creating enrollment markers"
      exports: ["createFacilitatorMarker"]
    - path: "packages/server/src/db/facilitators.ts"
      provides: "ensureFacilitatorMarker function called after facilitator creation"
      exports: ["ensureFacilitatorMarker"]
  key_links:
    - from: "packages/server/src/routes/admin.ts"
      to: "ensureFacilitatorMarker"
      via: "function call after createFacilitator"
      pattern: "ensureFacilitatorMarker\\(.*owner"
    - from: "packages/server/src/routes/internal-webhooks.ts"
      to: "ensureFacilitatorMarker"
      via: "function call after createFacilitator"
      pattern: "ensureFacilitatorMarker\\(.*owner"
    - from: "volume-aggregation.ts:152-161"
      to: "reward_addresses with chain_type=facilitator"
      via: "SQL query for enrollment date"
      pattern: "chain_type.*facilitator"
---

<objective>
Fix white-label facilitator volume tracking by creating missing enrollment markers.

Purpose: Users who own white-labeled facilitators should see their processed volume on the rewards page. Currently, volume tracking depends on `reward_addresses` records with `chain_type='facilitator'` as enrollment markers, but these are never created for facilitator owners.

Output:
- Backfill function to create markers for existing facilitator owners
- Automatic marker creation in facilitator creation flow
- All facilitator owners see their volume correctly
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-investigate-whitelabel-volume-tracking/16-RESEARCH.md
@.planning/phases/16-investigate-whitelabel-volume-tracking/16-CONTEXT.md

# Key source files
@packages/server/src/db/reward-addresses.ts
@packages/server/src/db/facilitators.ts
@packages/server/src/db/volume-aggregation.ts
@packages/server/src/routes/admin.ts
@packages/server/src/routes/internal-webhooks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add facilitator marker creation functions</name>
  <files>
    packages/server/src/db/reward-addresses.ts
    packages/server/src/db/facilitators.ts
  </files>
  <action>
Add two functions to handle facilitator enrollment markers:

1. In `packages/server/src/db/reward-addresses.ts`, add `createFacilitatorMarker(userId: string, enrollmentDate: string)`:
   - Creates a reward_address record with chain_type='facilitator'
   - Uses a deterministic address like `FACILITATOR_OWNER:{userId}` to satisfy UNIQUE constraint
   - Accepts enrollmentDate parameter (should be facilitator's created_at)
   - Manually updates created_at to enrollmentDate after insert (critical for historical volume)
   - Immediately marks as verified
   - Returns null silently if marker already exists (idempotent)
   - Use existing createRewardAddress pattern but customize for facilitator markers

2. In `packages/server/src/db/facilitators.ts`, add `ensureFacilitatorMarker(userId: string)`:
   - Finds user's earliest facilitator by created_at
   - Checks if facilitator marker already exists for user
   - If not, calls createFacilitatorMarker with earliest facilitator's created_at
   - Idempotent - safe to call multiple times
   - Export this function for use in routes

Key implementation details from RESEARCH.md:
- Use `FACILITATOR_OWNER:{userId}` as address (unique per user)
- Backdate created_at to facilitator.created_at to capture historical volume
- One marker per user (not per facilitator) - volume queries by owner_address
  </action>
  <verify>
TypeScript compiles without errors:
```bash
pnpm --filter=@openfacilitator/server build
```
  </verify>
  <done>
- createFacilitatorMarker exported from reward-addresses.ts
- ensureFacilitatorMarker exported from facilitators.ts
- Functions are idempotent (can be called multiple times safely)
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate marker creation into facilitator creation flow</name>
  <files>
    packages/server/src/routes/admin.ts
    packages/server/src/routes/internal-webhooks.ts
  </files>
  <action>
Add automatic marker creation when facilitators are created:

1. In `packages/server/src/routes/admin.ts`:
   - Import ensureFacilitatorMarker from '../db/facilitators.js'
   - In POST /api/admin/facilitators (around line 283), after createFacilitator succeeds:
     ```typescript
     // Ensure facilitator owner has enrollment marker for volume tracking
     ensureFacilitatorMarker(ownerAddress);
     ```

2. In `packages/server/src/routes/internal-webhooks.ts`:
   - Import ensureFacilitatorMarker from '../db/facilitators.js'
   - In createFacilitatorFromPending function (around line 87), after facilitator creation succeeds:
     ```typescript
     // Ensure facilitator owner has enrollment marker for volume tracking
     ensureFacilitatorMarker(pending.user_id);
     ```

Both locations create facilitators - admin creates directly, internal-webhooks creates after subscription payment. Both paths need marker creation.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
pnpm --filter=@openfacilitator/server build
```
  </verify>
  <done>
- admin.ts calls ensureFacilitatorMarker after facilitator creation
- internal-webhooks.ts calls ensureFacilitatorMarker after facilitator creation
- New facilitator owners will automatically get enrollment markers
  </done>
</task>

<task type="auto">
  <name>Task 3: Create and run backfill for existing facilitator owners</name>
  <files>
    packages/server/src/db/facilitators.ts
  </files>
  <action>
Add a backfill function to create missing markers for existing facilitator owners:

1. In `packages/server/src/db/facilitators.ts`, add `backfillFacilitatorMarkers()`:
   ```typescript
   /**
    * Backfill missing facilitator enrollment markers for all existing owners
    * Safe to run multiple times - ensureFacilitatorMarker is idempotent
    * @returns Number of markers created
    */
   export function backfillFacilitatorMarkers(): number {
     const db = getDatabase();

     // Find all unique facilitator owners
     const stmt = db.prepare(`
       SELECT DISTINCT owner_address
       FROM facilitators
     `);
     const owners = stmt.all() as { owner_address: string }[];

     let created = 0;
     for (const { owner_address } of owners) {
       const result = ensureFacilitatorMarker(owner_address);
       if (result) created++;
     }

     return created;
   }
   ```

2. Call the backfill immediately by adding a startup hook:
   - At the bottom of `packages/server/src/db/facilitators.ts`, add:
   ```typescript
   // Run backfill on module load to fix existing data
   // Safe because ensureFacilitatorMarker is idempotent
   try {
     const created = backfillFacilitatorMarkers();
     if (created > 0) {
       console.log(`[Facilitator Backfill] Created ${created} missing enrollment markers`);
     }
   } catch (error) {
     console.error('[Facilitator Backfill] Error during backfill:', error);
   }
   ```

This approach runs the backfill on server startup. Since ensureFacilitatorMarker is idempotent, it's safe to run on every startup - it will only create markers that don't exist.

Alternative: If module-load execution causes issues with database initialization timing, wrap in setTimeout(fn, 0) to defer to next tick, or export backfillFacilitatorMarkers and call from server.ts after database initialization.
  </action>
  <verify>
1. Server starts without errors:
```bash
cd packages/server && pnpm dev
# Check logs for "[Facilitator Backfill]" message
```

2. Verify markers were created by checking database (if sqlite CLI available):
```bash
sqlite3 packages/server/data/openfacilitator.db "SELECT COUNT(*) FROM reward_addresses WHERE chain_type = 'facilitator'"
```
  </verify>
  <done>
- backfillFacilitatorMarkers function exists and is exported
- Backfill runs on module load (or server startup)
- Existing facilitator owners now have enrollment markers
- Console log confirms how many markers were created
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   pnpm --filter=@openfacilitator/server build
   ```

2. **Server starts without errors:**
   ```bash
   cd packages/server && pnpm dev
   ```
   Check logs for backfill message.

3. **Database state verification (if sqlite available):**
   ```bash
   # All facilitator owners should have markers
   sqlite3 packages/server/data/openfacilitator.db "
     SELECT f.owner_address, ra.id as marker_id
     FROM facilitators f
     LEFT JOIN reward_addresses ra
       ON ra.user_id = f.owner_address
       AND ra.chain_type = 'facilitator'
     GROUP BY f.owner_address
   "
   # Every row should have a marker_id (no NULLs)
   ```

4. **Volume aggregation now works:**
   The getUserTotalVolume and getVolumeBreakdownByUser functions in volume-aggregation.ts will now find the facilitator enrollment markers and include facilitator-based volume in calculations.
</verification>

<success_criteria>
1. TypeScript compiles without errors
2. Server starts without errors
3. Backfill creates markers for existing facilitator owners (logged on startup)
4. New facilitator creation automatically creates enrollment marker
5. Volume aggregation queries find facilitator markers (no code changes needed in volume-aggregation.ts - data fix only)
</success_criteria>

<output>
After completion, create `.planning/phases/16-investigate-whitelabel-volume-tracking/16-01-SUMMARY.md`
</output>
