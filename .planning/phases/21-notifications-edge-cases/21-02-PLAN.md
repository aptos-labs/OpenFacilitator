---
phase: 21-notifications-edge-cases
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - apps/dashboard/src/components/ui/popover.tsx
  - apps/dashboard/src/components/notifications/notification-item.tsx
  - apps/dashboard/src/components/notifications/notification-center.tsx
  - apps/dashboard/src/components/notifications/notification-bell.tsx
  - apps/dashboard/src/hooks/use-notifications.ts
  - apps/dashboard/src/lib/api.ts
  - apps/dashboard/src/components/navbar.tsx
autonomous: true

must_haves:
  truths:
    - "User sees bell icon in header next to user menu"
    - "Clicking bell shows notification dropdown with list of notifications"
    - "Unread notifications show count badge on bell icon"
    - "User can dismiss individual notifications"
    - "User can mark all notifications as read"
    - "Notifications show severity-based styling (green/amber/red)"
  artifacts:
    - path: "apps/dashboard/src/components/notifications/notification-bell.tsx"
      provides: "Bell icon with badge trigger"
      min_lines: 20
    - path: "apps/dashboard/src/components/notifications/notification-center.tsx"
      provides: "Popover content with notification list"
      min_lines: 40
    - path: "apps/dashboard/src/components/notifications/notification-item.tsx"
      provides: "Individual notification card"
      min_lines: 30
    - path: "apps/dashboard/src/hooks/use-notifications.ts"
      provides: "React Query hook for notifications"
      exports: ["useNotifications"]
  key_links:
    - from: "apps/dashboard/src/components/notifications/notification-bell.tsx"
      to: "apps/dashboard/src/hooks/use-notifications.ts"
      via: "useNotifications hook"
      pattern: "useNotifications\\(\\)"
    - from: "apps/dashboard/src/components/navbar.tsx"
      to: "apps/dashboard/src/components/notifications/notification-bell.tsx"
      via: "component import"
      pattern: "NotificationBell"
    - from: "apps/dashboard/src/hooks/use-notifications.ts"
      to: "apps/dashboard/src/lib/api.ts"
      via: "API calls"
      pattern: "api\\.getNotifications|api\\.dismissNotification"
---

<objective>
Create the frontend notification center UI including bell icon with badge, notification dropdown, and integration with the navbar.

Purpose: Users can view and manage notifications for payment events, low balance warnings, and subscription reminders from any page in the dashboard.

Output: Fully functional notification center in the navbar with popover, severity styling, and dismiss functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-notifications-edge-cases/21-CONTEXT.md
@.planning/phases/21-notifications-edge-cases/21-RESEARCH.md
@.planning/phases/21-notifications-edge-cases/21-01-SUMMARY.md
@apps/dashboard/src/components/navbar.tsx
@apps/dashboard/src/components/user-menu.tsx
@apps/dashboard/src/components/ui/dropdown-menu.tsx
@apps/dashboard/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn popover and create notification components</name>
  <files>
    apps/dashboard/src/components/ui/popover.tsx
    apps/dashboard/src/components/notifications/notification-item.tsx
    apps/dashboard/src/components/notifications/notification-center.tsx
    apps/dashboard/src/components/notifications/notification-bell.tsx
    apps/dashboard/src/hooks/use-notifications.ts
    apps/dashboard/src/lib/api.ts
  </files>
  <action>
1. Install shadcn popover component:
   ```bash
   cd apps/dashboard && npx shadcn@latest add popover --yes
   ```
   This creates `apps/dashboard/src/components/ui/popover.tsx`

2. Add API methods to `apps/dashboard/src/lib/api.ts`:

   Add types near other subscription types:
   ```typescript
   export interface Notification {
     id: string;
     user_id: string;
     type: 'payment_success' | 'payment_failed' | 'low_balance' | 'expiration_reminder' | 'subscription_restored' | 'subscription_expired';
     title: string;
     message: string;
     severity: 'success' | 'warning' | 'error' | 'info';
     read: boolean;
     dismissed: boolean;
     metadata: Record<string, unknown>;
     created_at: string;
   }

   export interface NotificationsResponse {
     notifications: Notification[];
     unreadCount: number;
   }
   ```

   Add methods to ApiClient class:
   ```typescript
   async getNotifications(): Promise<NotificationsResponse> {
     return this.request('/api/notifications');
   }

   async markNotificationAsRead(id: string): Promise<{ success: boolean }> {
     return this.request(`/api/notifications/${id}/read`, { method: 'POST' });
   }

   async dismissNotification(id: string): Promise<{ success: boolean }> {
     return this.request(`/api/notifications/${id}/dismiss`, { method: 'POST' });
   }

   async markAllNotificationsAsRead(): Promise<{ success: boolean }> {
     return this.request('/api/notifications/mark-all-read', { method: 'POST' });
   }
   ```

3. Create `apps/dashboard/src/hooks/use-notifications.ts`:
   ```typescript
   import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
   import { api } from '@/lib/api';

   export function useNotifications() {
     const queryClient = useQueryClient();

     const { data, isLoading } = useQuery({
       queryKey: ['notifications'],
       queryFn: () => api.getNotifications(),
       refetchOnWindowFocus: true,
       staleTime: 30_000, // 30 seconds
     });

     const dismissMutation = useMutation({
       mutationFn: (id: string) => api.dismissNotification(id),
       onSuccess: () => {
         queryClient.invalidateQueries({ queryKey: ['notifications'] });
       },
     });

     const markAllReadMutation = useMutation({
       mutationFn: () => api.markAllNotificationsAsRead(),
       onSuccess: () => {
         queryClient.invalidateQueries({ queryKey: ['notifications'] });
       },
     });

     return {
       notifications: data?.notifications ?? [],
       unreadCount: data?.unreadCount ?? 0,
       isLoading,
       dismiss: dismissMutation.mutate,
       markAllRead: markAllReadMutation.mutate,
     };
   }
   ```

4. Create `apps/dashboard/src/components/notifications/notification-item.tsx`:
   ```typescript
   'use client';

   import { formatDistanceToNow } from 'date-fns';
   import { Check, AlertTriangle, AlertCircle, Info, X } from 'lucide-react';
   import { cva } from 'class-variance-authority';
   import type { Notification } from '@/lib/api';

   const itemVariants = cva(
     'relative flex gap-3 p-4 border-b last:border-0 transition-colors',
     {
       variants: {
         severity: {
           success: 'bg-green-50 dark:bg-green-950/20',
           warning: 'bg-amber-50 dark:bg-amber-950/20',
           error: 'bg-red-50 dark:bg-red-950/20',
           info: 'bg-background',
         },
         read: {
           true: 'opacity-70',
           false: '',
         },
       },
       defaultVariants: {
         severity: 'info',
         read: false,
       },
     }
   );

   const iconMap = {
     success: Check,
     warning: AlertTriangle,
     error: AlertCircle,
     info: Info,
   };

   const iconColorMap = {
     success: 'text-green-600',
     warning: 'text-amber-600',
     error: 'text-red-600',
     info: 'text-muted-foreground',
   };

   interface NotificationItemProps {
     notification: Notification;
     onDismiss: (id: string) => void;
   }

   export function NotificationItem({ notification, onDismiss }: NotificationItemProps) {
     const Icon = iconMap[notification.severity];

     return (
       <div className={itemVariants({ severity: notification.severity, read: notification.read })}>
         <div className="flex-shrink-0 mt-0.5">
           <Icon className={`w-5 h-5 ${iconColorMap[notification.severity]}`} />
         </div>
         <div className="flex-1 min-w-0">
           <p className="text-sm font-medium text-foreground">{notification.title}</p>
           <p className="text-sm text-muted-foreground mt-0.5">{notification.message}</p>
           <p className="text-xs text-muted-foreground mt-1">
             {formatDistanceToNow(new Date(notification.created_at), { addSuffix: true })}
           </p>
         </div>
         <button
           onClick={(e) => {
             e.stopPropagation();
             onDismiss(notification.id);
           }}
           className="flex-shrink-0 p-1 rounded-md hover:bg-muted transition-colors"
           aria-label="Dismiss notification"
         >
           <X className="w-4 h-4 text-muted-foreground" />
         </button>
       </div>
     );
   }
   ```

5. Create `apps/dashboard/src/components/notifications/notification-center.tsx`:
   ```typescript
   'use client';

   import { useNotifications } from '@/hooks/use-notifications';
   import { NotificationItem } from './notification-item';
   import { Button } from '@/components/ui/button';
   import { Bell } from 'lucide-react';

   export function NotificationCenter() {
     const { notifications, isLoading, dismiss, markAllRead, unreadCount } = useNotifications();

     if (isLoading) {
       return (
         <div className="p-4 text-center">
           <div className="w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto" />
         </div>
       );
     }

     if (notifications.length === 0) {
       return (
         <div className="p-8 text-center">
           <Bell className="w-8 h-8 text-muted-foreground mx-auto mb-2" />
           <p className="text-sm text-muted-foreground">No notifications</p>
         </div>
       );
     }

     return (
       <div className="flex flex-col max-h-[400px]">
         <div className="flex items-center justify-between px-4 py-2 border-b">
           <h3 className="font-medium text-sm">Notifications</h3>
           {unreadCount > 0 && (
             <Button
               variant="ghost"
               size="sm"
               className="text-xs h-auto py-1"
               onClick={() => markAllRead()}
             >
               Mark all as read
             </Button>
           )}
         </div>
         <div className="overflow-y-auto">
           {notifications.map((notification) => (
             <NotificationItem
               key={notification.id}
               notification={notification}
               onDismiss={dismiss}
             />
           ))}
         </div>
       </div>
     );
   }
   ```

6. Create `apps/dashboard/src/components/notifications/notification-bell.tsx`:
   ```typescript
   'use client';

   import { Bell } from 'lucide-react';
   import {
     Popover,
     PopoverContent,
     PopoverTrigger,
   } from '@/components/ui/popover';
   import { NotificationCenter } from './notification-center';
   import { useNotifications } from '@/hooks/use-notifications';

   export function NotificationBell() {
     const { unreadCount } = useNotifications();

     return (
       <Popover>
         <PopoverTrigger asChild>
           <button
             className="relative p-2 text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100 focus:outline-none transition-colors"
             aria-label={`Notifications${unreadCount > 0 ? ` (${unreadCount} unread)` : ''}`}
           >
             <Bell className="w-5 h-5" />
             {unreadCount > 0 && (
               <span className="absolute -top-0.5 -right-0.5 flex items-center justify-center min-w-[18px] h-[18px] px-1 text-[10px] font-medium text-white bg-red-500 rounded-full">
                 {unreadCount > 99 ? '99+' : unreadCount}
               </span>
             )}
           </button>
         </PopoverTrigger>
         <PopoverContent align="end" className="w-80 p-0">
           <NotificationCenter />
         </PopoverContent>
       </Popover>
     );
   }
   ```
  </action>
  <verify>
Run `npm run build` in apps/dashboard to verify TypeScript compiles without errors.
  </verify>
  <done>
All notification components created, hook implemented, API methods added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate notification bell into navbar</name>
  <files>
    apps/dashboard/src/components/navbar.tsx
  </files>
  <action>
Modify `apps/dashboard/src/components/navbar.tsx`:

1. Import NotificationBell at the top:
   ```typescript
   import { NotificationBell } from '@/components/notifications/notification-bell';
   ```

2. In the desktop nav section (inside `{/* Auth-aware section */}`), add NotificationBell BEFORE the Admin badge and UserMenu, but only when authenticated:

   Find this block (around line 120-138):
   ```typescript
   {isLoading ? (
     <div className="w-20 h-8 bg-muted rounded animate-pulse" />
   ) : isAuthenticated ? (
     <div className="flex items-center gap-2">
       {isAdmin && (
         <span className="text-xs px-2 py-0.5 rounded bg-muted text-muted-foreground font-medium">
           Admin
         </span>
       )}
       <UserMenu />
     </div>
   ) : (
   ```

   Replace with:
   ```typescript
   {isLoading ? (
     <div className="w-20 h-8 bg-muted rounded animate-pulse" />
   ) : isAuthenticated ? (
     <div className="flex items-center gap-2">
       <NotificationBell />
       {isAdmin && (
         <span className="text-xs px-2 py-0.5 rounded bg-muted text-muted-foreground font-medium">
           Admin
         </span>
       )}
       <UserMenu />
     </div>
   ) : (
   ```

3. In the mobile menu section (inside the authenticated state, around line 189-195), add NotificationBell:

   Find this block:
   ```typescript
   <div className="px-3 py-3">
     <div className="flex items-center gap-2">
       {isAdmin && (
         <span className="text-xs px-2 py-0.5 rounded bg-muted text-muted-foreground font-medium">
           Admin
         </span>
       )}
       <UserMenu />
     </div>
   </div>
   ```

   Replace with:
   ```typescript
   <div className="px-3 py-3">
     <div className="flex items-center gap-2">
       <NotificationBell />
       {isAdmin && (
         <span className="text-xs px-2 py-0.5 rounded bg-muted text-muted-foreground font-medium">
           Admin
         </span>
       )}
       <UserMenu />
     </div>
   </div>
   ```
  </action>
  <verify>
1. Run `npm run build` in apps/dashboard - should compile without errors
2. Start dev server with `npm run dev` in apps/dashboard
3. Navigate to dashboard while authenticated
4. Verify bell icon appears next to user menu in both desktop and mobile views
5. Click bell icon - popover should appear with "No notifications" empty state
  </verify>
  <done>
Bell icon visible in navbar for authenticated users, notification center popover functional.
  </done>
</task>

</tasks>

<verification>
1. shadcn popover component installed
2. All notification components exist and compile
3. Hook fetches data from API correctly
4. Bell icon visible in navbar when authenticated
5. Popover opens on click
6. Empty state shows when no notifications
7. Notifications display with correct severity styling
8. Dismiss button removes notifications
9. Mark all as read button works
10. Badge count updates after mutations
</verification>

<success_criteria>
- Bell icon appears in header next to user menu (desktop and mobile)
- Clicking bell shows notification dropdown
- Unread count badge shows on bell icon when notifications exist
- Notifications styled by severity (green success, amber warning, red error)
- Individual notifications dismissable via X button
- "Mark all as read" button functional
- Empty state shown when no notifications
- Relative timestamps displayed ("2 hours ago")
</success_criteria>

<output>
After completion, create `.planning/phases/21-notifications-edge-cases/21-02-SUMMARY.md`
</output>
