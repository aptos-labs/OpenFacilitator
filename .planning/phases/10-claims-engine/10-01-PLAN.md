---
phase: 10-claims-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/services/reward-claims.ts
  - packages/server/src/routes/rewards.ts
  - packages/server/src/db/reward-claims.ts
  - apps/dashboard/src/lib/api.ts
  - apps/dashboard/src/components/rewards/progress-dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "User can see if they are eligible for claiming (threshold met AND campaign ended)"
    - "User sees reason why claim is disabled if not eligible"
    - "System creates claim record with calculated reward when user checks eligibility"
    - "Facilitator owners see 2x multiplier applied to their reward"
  artifacts:
    - path: "packages/server/src/services/reward-claims.ts"
      provides: "Claim eligibility and reward calculation service"
      exports: ["checkClaimEligibility", "calculateReward", "createOrGetClaimRecord"]
    - path: "packages/server/src/routes/rewards.ts"
      provides: "Eligibility check endpoint"
      contains: "GET /campaigns/:id/eligibility"
  key_links:
    - from: "apps/dashboard/src/components/rewards/progress-dashboard.tsx"
      to: "/api/rewards/campaigns/:id/eligibility"
      via: "API call to check eligibility"
      pattern: "eligibility"
    - from: "packages/server/src/services/reward-claims.ts"
      to: "packages/server/src/db/reward-claims.ts"
      via: "createRewardClaim function"
      pattern: "createRewardClaim"
---

<objective>
Implement claim eligibility checking and reward calculation. Users can see if they qualify for claiming (threshold met + campaign ended + within 30-day window), view their calculated reward amount with multiplier applied, and understand why claims are disabled if not eligible.

Purpose: Prerequisite for claim execution - must know eligibility and reward amount before initiating transfer.
Output: Eligibility service, API endpoint, and enhanced frontend eligibility display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-claims-engine/10-CONTEXT.md
@.planning/phases/10-claims-engine/10-RESEARCH.md
@.planning/phases/09-wallet-connection/09-01-SUMMARY.md

# Existing claim infrastructure
@packages/server/src/db/reward-claims.ts
@packages/server/src/routes/rewards.ts (lines 975-1100)
@apps/dashboard/src/components/rewards/progress-dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reward claims service with eligibility and calculation logic</name>
  <files>
    packages/server/src/services/reward-claims.ts
    packages/server/src/db/reward-claims.ts
  </files>
  <action>
Create new service `packages/server/src/services/reward-claims.ts` with:

1. `checkClaimEligibility(userId: string, campaignId: string)` function:
   - Get campaign by ID, return error if not found
   - Check campaign status is 'ended' (now >= ends_at)
   - Check claim window: now <= ends_at + 30 days (from CONTEXT.md)
   - Get user's volume using `getUserTotalVolume()`
   - Check threshold: volume >= threshold_amount
   - Check for existing claim record
   - Return structured result:
     ```typescript
     interface EligibilityResult {
       eligible: boolean;
       reason?: string;  // Why not eligible
       claim?: RewardClaimRecord;  // Existing or newly created
       calculatedReward?: {
         baseReward: string;
         finalReward: string;
         multiplier: number;
       };
     }
     ```

2. `calculateReward(params)` function:
   - Takes: userVolume, totalPoolVolume, poolAmount, isFacilitatorOwner, multiplier
   - Use BigInt for all calculations (amounts are strings)
   - Apply multiplier to effective volume for facilitator owners
   - Calculate proportional share: (effectiveVolume / totalPoolVolume) * poolAmount
   - Return: { baseReward, finalReward, effectiveMultiplier }

3. `createOrGetClaimRecord(userId, campaignId, calculatedReward)` function:
   - Check for existing claim using `getRewardClaimByUserAndCampaign()`
   - If exists, return it
   - If not, create new claim with status='pending' using `createRewardClaim()`
   - Store: volume_amount, base_reward_amount, multiplier, final_reward_amount

Also update `packages/server/src/db/reward-claims.ts` to add `getTotalQualifyingVolume(campaignId: string)` that returns sum of all users' volumes for the campaign (needed for proportional calculation).
  </action>
  <verify>
    TypeScript compiles: `pnpm -F @openfacilitator/server exec tsc --noEmit`
  </verify>
  <done>
    Service exports checkClaimEligibility, calculateReward, createOrGetClaimRecord.
    All BigInt calculations use string amounts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add eligibility API endpoint and update frontend</name>
  <files>
    packages/server/src/routes/rewards.ts
    apps/dashboard/src/lib/api.ts
    apps/dashboard/src/components/rewards/progress-dashboard.tsx
  </files>
  <action>
1. Add endpoint to `packages/server/src/routes/rewards.ts`:

```typescript
/**
 * GET /campaigns/:id/eligibility
 * Check if current user is eligible to claim for a campaign
 * Creates claim record if eligible and none exists
 */
router.get('/campaigns/:id/eligibility', requireAuth, async (req, res) => {
  // Get userId, campaignId
  // Call checkClaimEligibility service
  // Return structured eligibility response
});
```

2. Update `apps/dashboard/src/lib/api.ts`:
   - Add `getClaimEligibility(campaignId: string)` method
   - Type the response: EligibilityResponse

3. Update `apps/dashboard/src/components/rewards/progress-dashboard.tsx`:
   - When campaign has ended and user met threshold but no claim exists:
     - Call eligibility API to create claim record
     - Show claim button once claim exists
   - When not eligible, show specific reason:
     - "Campaign has not ended yet" (shouldn't happen in ended view)
     - "Claim window has expired (30 days after campaign end)"
     - "Volume below threshold: X more needed"
   - When claim exists, show ClaimButton with reward amount
  </action>
  <verify>
    Test eligibility endpoint:
    ```bash
    curl -X GET http://localhost:5002/api/rewards/campaigns/{campaignId}/eligibility \
      -H "Cookie: better-auth.session_token=..." \
      -H "Content-Type: application/json"
    ```
    Should return eligibility status with reason or claim record.
  </verify>
  <done>
    Eligibility endpoint returns structured response.
    Frontend shows specific reasons for ineligibility.
    Claim record created when user checks eligibility and is eligible.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles in both packages/server and apps/dashboard
2. Eligibility check returns correct status for:
   - User who met threshold (eligible: true, claim created)
   - User who didn't meet threshold (eligible: false, reason about volume)
   - Campaign that hasn't ended (eligible: false, reason about campaign status)
3. Reward calculation applies 2x multiplier for facilitator owners
4. Frontend shows appropriate eligibility status after campaign ends
</verification>

<success_criteria>
- User sees eligibility status when campaign ends
- Ineligible users see specific reason why
- Eligible users have claim record created with calculated reward
- Facilitator multiplier is correctly applied to reward calculation
</success_criteria>

<output>
After completion, create `.planning/phases/10-claims-engine/10-01-SUMMARY.md`
</output>
