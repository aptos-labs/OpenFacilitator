---
phase: 10-claims-engine
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - apps/dashboard/package.json
  - apps/dashboard/src/components/rewards/claim-modal.tsx
  - apps/dashboard/src/components/rewards/claim-history.tsx
  - apps/dashboard/src/app/rewards/page.tsx
  - apps/dashboard/src/lib/api.ts
  - packages/server/src/routes/rewards.ts
autonomous: true

must_haves:
  truths:
    - "User sees confetti animation on successful claim"
    - "User can share claim success on Twitter/X"
    - "User can view claim history with status and transaction links"
    - "Success modal shows Solscan link for transaction"
  artifacts:
    - path: "apps/dashboard/src/components/rewards/claim-modal.tsx"
      provides: "Enhanced success state with confetti and share"
      contains: "confetti"
    - path: "apps/dashboard/src/components/rewards/claim-history.tsx"
      provides: "Claim history list component"
      exports: ["ClaimHistory"]
  key_links:
    - from: "apps/dashboard/src/components/rewards/claim-modal.tsx"
      to: "canvas-confetti"
      via: "confetti import"
      pattern: "import confetti"
    - from: "apps/dashboard/src/app/rewards/page.tsx"
      to: "apps/dashboard/src/components/rewards/claim-history.tsx"
      via: "component import"
      pattern: "ClaimHistory"
---

<objective>
Enhance the claim success experience with celebratory UI (confetti, Twitter share) and implement claim history display. Users feel rewarded for claiming, can share their achievement, and can review past claims.

Purpose: Delightful user experience and social sharing for organic growth.
Output: Enhanced ClaimModal, ClaimHistory component, updated rewards page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-claims-engine/10-CONTEXT.md
@.planning/phases/10-claims-engine/10-RESEARCH.md

# Existing claim modal
@apps/dashboard/src/components/rewards/claim-modal.tsx

# Phase 10-01 outputs (reference after completion)
# @.planning/phases/10-claims-engine/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add confetti library and enhance ClaimModal success state</name>
  <files>
    apps/dashboard/package.json
    apps/dashboard/src/components/rewards/claim-modal.tsx
  </files>
  <action>
1. Install canvas-confetti in apps/dashboard:
   ```bash
   cd apps/dashboard && pnpm add canvas-confetti && pnpm add -D @types/canvas-confetti
   ```

2. Update `apps/dashboard/src/components/rewards/claim-modal.tsx`:

   a. Add imports:
   ```typescript
   import confetti from 'canvas-confetti';
   import { Twitter } from 'lucide-react';  // or use X icon if available
   ```

   b. Add confetti trigger function (from RESEARCH.md):
   ```typescript
   function celebrateClaim() {
     // Fire from center
     confetti({
       particleCount: 100,
       spread: 70,
       origin: { y: 0.6 }
     });

     // Side bursts for dramatic effect
     setTimeout(() => {
       confetti({
         particleCount: 50,
         angle: 60,
         spread: 55,
         origin: { x: 0 }
       });
       confetti({
         particleCount: 50,
         angle: 120,
         spread: 55,
         origin: { x: 1 }
       });
     }, 200);
   }
   ```

   c. Add Twitter share function (from RESEARCH.md):
   ```typescript
   function shareOnTwitter(amount: string, txSignature: string) {
     const text = `I just claimed ${formatTokenAmount(amount)} $OPEN tokens from @OpenFacilitator rewards! `;
     const url = `https://solscan.io/tx/${txSignature}`;

     const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;

     window.open(
       twitterUrl,
       'twitter-share',
       'width=550,height=450,menubar=no,toolbar=no,resizable=yes,scrollbars=yes'
     );
   }
   ```

   d. Update state to track txSignature:
   ```typescript
   const [txSignature, setTxSignature] = useState<string | null>(null);
   ```

   e. Update handleConfirm to:
   - Store tx_signature from response (if returned by initiateClaim after 10-02)
   - On success, call celebrateClaim()
   - Set txSignature state

   f. Update success state UI (status === 'success'):
   - Larger celebratory icon (maybe a gift or star icon)
   - Show claimed amount prominently with green styling
   - Show wallet address with Solscan account link
   - Show transaction link if txSignature exists:
     ```tsx
     {txSignature && (
       <a
         href={`https://solscan.io/tx/${txSignature}`}
         target="_blank"
         rel="noopener noreferrer"
         className="inline-flex items-center gap-1 text-sm text-primary hover:underline"
       >
         View transaction
         <ExternalLink className="h-3 w-3" />
       </a>
     )}
     ```
   - Add Twitter share button:
     ```tsx
     <Button
       variant="outline"
       onClick={() => shareOnTwitter(rewardAmount, txSignature!)}
       disabled={!txSignature}
       className="mt-4"
     >
       <Twitter className="h-4 w-4 mr-2" />
       Share on X
     </Button>
     ```
   - Keep Done button at bottom (from CONTEXT.md: modal requires manual close)
  </action>
  <verify>
    Build succeeds: `pnpm -F dashboard build`
    Confetti package installed: `pnpm -F dashboard exec -- npm ls canvas-confetti`
  </verify>
  <done>
    ClaimModal shows confetti on success.
    Twitter share button opens pre-filled tweet.
    Transaction link visible when signature available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ClaimHistory component and add to rewards page</name>
  <files>
    apps/dashboard/src/components/rewards/claim-history.tsx
    apps/dashboard/src/app/rewards/page.tsx
    apps/dashboard/src/lib/api.ts
    packages/server/src/routes/rewards.ts
  </files>
  <action>
1. Add API endpoint for claim history in `packages/server/src/routes/rewards.ts`:
   ```typescript
   /**
    * GET /claims/history
    * Get current user's claim history across all campaigns
    */
   router.get('/claims/history', requireAuth, async (req, res) => {
     const userId = req.user!.id;
     const claims = getRewardClaimsByUser(userId);

     // Enrich with campaign info
     const enrichedClaims = claims.map(claim => {
       const campaign = getCampaignById(claim.campaign_id);
       return {
         ...claim,
         campaign_name: campaign?.name ?? 'Unknown Campaign',
       };
     });

     res.json({ claims: enrichedClaims });
   });
   ```

2. Add API client method in `apps/dashboard/src/lib/api.ts`:
   ```typescript
   async getClaimHistory(): Promise<{
     claims: Array<RewardClaim & { campaign_name: string }>;
   }> {
     return this.request('/api/rewards/claims/history');
   }
   ```

3. Create `apps/dashboard/src/components/rewards/claim-history.tsx`:
   ```typescript
   'use client';

   import { ExternalLink, CheckCircle, Clock, AlertCircle, Loader2 } from 'lucide-react';
   import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
   import type { RewardClaim } from '@/lib/api';

   interface ClaimHistoryProps {
     claims: Array<RewardClaim & { campaign_name: string }>;
   }

   function formatTokenAmount(amount: string): string {
     const value = Number(amount) / 1_000_000_000;
     return new Intl.NumberFormat('en-US', {
       minimumFractionDigits: 0,
       maximumFractionDigits: 2,
     }).format(value);
   }

   function formatDate(dateStr: string): string {
     return new Date(dateStr).toLocaleDateString('en-US', {
       year: 'numeric',
       month: 'short',
       day: 'numeric',
     });
   }

   function truncateAddress(address: string): string {
     return `${address.slice(0, 6)}...${address.slice(-4)}`;
   }

   function StatusIcon({ status }: { status: string }) {
     switch (status) {
       case 'completed':
         return <CheckCircle className="h-5 w-5 text-green-500" />;
       case 'processing':
         return <Loader2 className="h-5 w-5 text-amber-500 animate-spin" />;
       case 'failed':
         return <AlertCircle className="h-5 w-5 text-red-500" />;
       default:
         return <Clock className="h-5 w-5 text-muted-foreground" />;
     }
   }

   export function ClaimHistory({ claims }: ClaimHistoryProps) {
     if (claims.length === 0) {
       return (
         <Card>
           <CardContent className="py-8 text-center text-muted-foreground">
             <p>No claims yet. Participate in campaigns to earn rewards!</p>
           </CardContent>
         </Card>
       );
     }

     return (
       <Card>
         <CardHeader>
           <CardTitle>Your Claims</CardTitle>
         </CardHeader>
         <CardContent>
           <div className="space-y-4">
             {claims.map(claim => (
               <div
                 key={claim.id}
                 className="flex items-center justify-between p-4 rounded-lg border bg-card"
               >
                 <div className="flex items-center gap-4">
                   <StatusIcon status={claim.status} />
                   <div>
                     <p className="font-medium">{claim.campaign_name}</p>
                     <p className="text-sm text-muted-foreground">
                       {claim.claimed_at
                         ? formatDate(claim.claimed_at)
                         : formatDate(claim.created_at)}
                     </p>
                   </div>
                 </div>
                 <div className="text-right">
                   <p className="font-semibold text-lg">
                     {formatTokenAmount(claim.final_reward_amount)} $OPEN
                   </p>
                   {claim.multiplier > 1 && (
                     <p className="text-xs text-purple-600 dark:text-purple-400">
                       {claim.multiplier}x multiplier applied
                     </p>
                   )}
                   <div className="flex items-center gap-2 mt-1 justify-end">
                     {claim.claim_wallet && (
                       <a
                         href={`https://solscan.io/account/${claim.claim_wallet}`}
                         target="_blank"
                         rel="noopener noreferrer"
                         className="text-xs text-muted-foreground hover:text-primary"
                       >
                         {truncateAddress(claim.claim_wallet)}
                       </a>
                     )}
                     {claim.tx_signature && (
                       <a
                         href={`https://solscan.io/tx/${claim.tx_signature}`}
                         target="_blank"
                         rel="noopener noreferrer"
                         className="inline-flex items-center gap-1 text-xs text-primary hover:underline"
                       >
                         <ExternalLink className="h-3 w-3" />
                       </a>
                     )}
                   </div>
                 </div>
               </div>
             ))}
           </div>
         </CardContent>
       </Card>
     );
   }
   ```

4. Update `apps/dashboard/src/app/rewards/page.tsx`:
   - Import ClaimHistory
   - Add query for claim history:
     ```typescript
     const { data: claimHistoryData } = useQuery({
       queryKey: ['claimHistory'],
       queryFn: () => api.getClaimHistory(),
     });
     ```
   - Add ClaimHistory section below Campaign History:
     ```tsx
     {/* Claim History */}
     {claimHistoryData?.claims && claimHistoryData.claims.length > 0 && (
       <div>
         <h2 className="text-xl font-semibold mb-4">Your Claims</h2>
         <ClaimHistory claims={claimHistoryData.claims} />
       </div>
     )}
     ```
  </action>
  <verify>
    Build succeeds: `pnpm -F dashboard build`
    API endpoint returns claim history for authenticated user.
  </verify>
  <done>
    ClaimHistory component displays user's claims with status, amounts, and links.
    Rewards page shows claim history section.
    Claims show campaign name, amount, multiplier, and transaction link.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds for apps/dashboard
2. ClaimModal:
   - Confetti fires on successful claim
   - Twitter share button opens pre-filled tweet popup
   - Transaction link navigates to Solscan
3. ClaimHistory:
   - Shows all user claims with correct status icons
   - Links to Solscan for wallet and transaction
   - Shows multiplier badge when applied
4. Rewards page displays claim history section
</verification>

<success_criteria>
- Successful claim triggers celebratory confetti animation
- User can share achievement on Twitter/X
- User can view all past claims with status and transaction details
- All Solscan links work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/10-claims-engine/10-03-SUMMARY.md`
</output>
